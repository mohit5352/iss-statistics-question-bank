<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ISS Statistics Paper I Archive</title>
    <link rel="stylesheet" href="styles.css?v=2">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

    <div class="paper-container">
        <h1>ISS Statistics Paper I</h1>
        <h2>Question Bank</h2>
        
        <div class="meta-controls">
            <div class="meta-line meta-section">
                <span class="meta-label">Section</span>
                <span class="meta-value" id="section-value">Probability &amp; Statistics</span>
                <select id="section-select" onchange="setSection(this.value)">
                    <option value="prob">Probability &amp; Statistics</option>
                    <option value="num">Numerical Analysis</option>
                    <option value="comp">Computer Section</option>
                </select>
            </div>
            <div class="meta-line meta-year">
                <span class="meta-label">Year</span>
                <span class="meta-value" id="year-value">2025</span>
                <select id="year-select" onchange="loadYear(this.value)">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                    <option value="2017">2017</option>
                </select>
            </div>
        </div>
    
        <!-- Use iframe for desktop, div for mobile -->
        <iframe id="year-viewer-iframe" width="100%" frameborder="0" style="border: none; display: none;"></iframe>
        <div id="year-viewer" class="content-viewer" style="display: none;"></div>
    </div>
    
    <script>
        // Track current selection for full Paper I (three sections)
        var currentYear = '2025';
        var currentSection = 'prob'; // 'prob' | 'num' | 'comp'
        
        // Detect if we should use iframe (desktop) or fetch (mobile)
        var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        var isFileProtocol = window.location.protocol === 'file:';
        var useIframe = !isMobile && isFileProtocol; // Use iframe on desktop with file://, fetch on mobile or http://

        function buildFilename() {
            var prefix;
            var basePath = 'extracted_htmls/stats_paper_1/';
            if (currentSection === 'prob') {
                // Probability & Statistics files
                prefix = basePath + 'Probability_&_Statistics/Probability_and_Statistics_questions_';
            } else if (currentSection === 'num') {
                // Numerical Analysis section
                prefix = basePath + 'Numerical_Analysis/Numerical_Analysis_questions_';
            } else if (currentSection === 'comp') {
                // Computer section
                prefix = basePath + 'Computer/Computer_questions_';
            } else {
                // Fallback to Probability & Statistics
                prefix = basePath + 'Probability_&_Statistics/Probability_and_Statistics_questions_';
            }
            return prefix + currentYear + '.html';
        }

        // Copy button functionality - DRY principle
        function addCopyButtons(container) {
            var questionCards = container.querySelectorAll('.question-card');
            questionCards.forEach(function(card) {
                // Skip if button already exists
                if (card.querySelector('.q-copy-btn')) {
                    return;
                }
                
                // Create copy button
                var copyBtn = document.createElement('button');
                copyBtn.className = 'q-copy-btn';
                copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg><span>Copy</span>';
                copyBtn.setAttribute('aria-label', 'Copy question');
                
                // Add click handler
                copyBtn.addEventListener('click', function() {
                    copyQuestionText(card, copyBtn);
                });
                
                // Insert button into card
                card.style.position = 'relative';
                card.appendChild(copyBtn);
            });
        }

        function copyQuestionText(card, button) {
            try {
                // Extract question number
                var qNumberEl = card.querySelector('.q-number');
                var qNumber = qNumberEl ? qNumberEl.textContent.trim() : '';
                
                // Extract topic
                var qTopicEl = card.querySelector('.q-topic');
                var qTopic = qTopicEl ? qTopicEl.textContent.trim() : '';
                
                // Extract all question text (handle multiple q-text divs)
                var qTextEls = card.querySelectorAll('.q-text');
                var qText = '';
                qTextEls.forEach(function(el) {
                    var text = el.textContent.trim();
                    if (text) {
                        qText += text + '\n';
                    }
                });
                qText = qText.trim();
                
                // Extract context if exists
                var qContextEl = card.querySelector('.q-context');
                var qContext = '';
                if (qContextEl) {
                    qContext = qContextEl.textContent.trim() + '\n\n';
                }
                
                // Extract options
                var options = [];
                var optionItems = card.querySelectorAll('.option-item');
                optionItems.forEach(function(item) {
                    var optText = item.textContent.trim();
                    if (optText) {
                        options.push(optText);
                    }
                });
                
                // Build formatted text
                var formattedText = '';
                if (qContext) {
                    formattedText += qContext;
                }
                if (qNumber) {
                    formattedText += qNumber + ' ';
                }
                if (qTopic) {
                    formattedText += qTopic + '\n';
                }
                if (qText) {
                    formattedText += qText + '\n\n';
                }
                if (options.length > 0) {
                    formattedText += 'Options:\n';
                    options.forEach(function(opt) {
                        formattedText += opt + '\n';
                    });
                }
                
                // Copy to clipboard
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(formattedText).then(function() {
                        showCopySuccess(button);
                    }).catch(function(err) {
                        console.error('Failed to copy:', err);
                        fallbackCopy(formattedText, button);
                    });
                } else {
                    fallbackCopy(formattedText, button);
                }
            } catch (error) {
                console.error('Error copying question:', error);
            }
        }

        function showCopySuccess(button) {
            var originalHTML = button.innerHTML;
            button.classList.add('copied');
            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg><span>Copied!</span>';
            setTimeout(function() {
                button.classList.remove('copied');
                button.innerHTML = originalHTML;
            }, 2000);
        }

        function fallbackCopy(text, button) {
            // Fallback for older browsers
            var textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showCopySuccess(button);
            } catch (err) {
                console.error('Fallback copy failed:', err);
            }
            document.body.removeChild(textArea);
        }


        function updateControlsUI() {
            var sectionValueEl = document.getElementById('section-value');
            var yearValueEl = document.getElementById('year-value');

            if (sectionValueEl) {
                var sectionText = 'Probability & Statistics';
                if (currentSection === 'num') {
                    sectionText = 'Numerical Analysis';
                } else if (currentSection === 'comp') {
                    sectionText = 'Computer Section';
                }
                sectionValueEl.textContent = sectionText;
            }

            if (yearValueEl) {
                yearValueEl.textContent = currentYear;
            }
        }

        // Load content using iframe (for desktop file://)
        function loadContentIframe() {
            var iframe = document.getElementById('year-viewer-iframe');
            var div = document.getElementById('year-viewer');
            var filename = buildFilename();
            
            iframe.style.display = 'block';
            div.style.display = 'none';
            
            // Load content via fetch and inject into iframe to avoid CORS issues
            fetch(filename)
                .then(function(response) {
                    if (!response.ok) throw new Error('File not found');
                    return response.text();
                })
                .then(function(html) {
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(html, 'text/html');
                    var bodyContent = doc.body.innerHTML;
                    
                    // Inject copy button script into body content  
                    // Note: Copy buttons will be added via iframe onload handler instead
                    // to avoid script injection issues
                    
                    // Write to iframe
                    var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    var iframeWindow = iframe.contentWindow;
                    iframeDoc.open();
                    // Use absolute path for stylesheet (from main.html's location)
                    var basePath = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                    // Inject copy button CSS directly to ensure it loads
                    var copyButtonCSS = '<style>.q-copy-btn{position:absolute;top:12px;right:12px;background:#6366f1;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;font-size:0.875rem;font-weight:600;display:flex;align-items:center;gap:6px;transition:background-color 0.2s ease,transform 0.1s ease;box-shadow:0 2px 4px rgba(99,102,241,0.2);z-index:10;}.q-copy-btn:hover{background:#4f46e5;transform:translateY(-1px);box-shadow:0 4px 8px rgba(99,102,241,0.3);}.q-copy-btn:active{transform:translateY(0);background:#4338ca;}.q-copy-btn.copied{background:#10b981;}.q-copy-btn.copied:hover{background:#059669;}.q-copy-btn svg{width:16px;height:16px;fill:currentColor;}@media (max-width:768px){.q-copy-btn{top:8px;right:8px;padding:6px 10px;font-size:0.8rem;}.q-copy-btn svg{width:14px;height:14px;}}.question-card{position:relative;}</style>';
                    // Include MathJax scripts in iframe (using proper escaping)
                    var mathJaxScripts = '<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"><\/script><script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>';
                    iframeDoc.write('<!DOCTYPE html><html><head><base href="' + basePath + '"><link rel="stylesheet" href="styles.css">' + copyButtonCSS + mathJaxScripts + '</head><body>' + bodyContent + '</body></html>');
                    iframeDoc.close();
                    
                    // Add copy buttons after iframe content loads
                    setTimeout(function() {
                        try {
                            addCopyButtons(iframeDoc.body);
                            console.log('Copy buttons added to iframe');
                        } catch (e) {
                            console.log('Could not add copy buttons to iframe:', e);
                        }
                    }, 200);
                    
                    // Initialize MathJax in iframe (wait for it to load)
                    function initMathJaxInIframe() {
                        if (iframeWindow.MathJax && iframeWindow.MathJax.typesetPromise) {
                            iframeWindow.MathJax.typesetPromise([iframeDoc.body]).catch(function(err) {
                                console.log('MathJax error in iframe:', err);
                            });
                        } else {
                            // Wait a bit more for MathJax to load
                            setTimeout(initMathJaxInIframe, 100);
                        }
                    }
                    
                    // Start MathJax initialization after a short delay
                    setTimeout(initMathJaxInIframe, 300);
                })
                .catch(function(error) {
                    console.error('Error loading file:', error);
                    // Fallback to direct iframe load
                    iframe.src = filename;
                    iframe.onload = function() {
                        try {
                            var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            setTimeout(function() {
                                addCopyButtons(iframeDoc.body);
                            }, 100);
                        } catch (e) {
                            console.log('Cannot access iframe content:', e);
                        }
                    };
                });
            
            // Adjust iframe height
            adjustIframeHeight();
        }

        // Load content using fetch/XHR (for mobile or http://)
        function loadContentFetch() {
            var iframe = document.getElementById('year-viewer-iframe');
            var viewer = document.getElementById('year-viewer');
            var filename = buildFilename();
            
            iframe.style.display = 'none';
            viewer.style.display = 'block';
            
            // Show loading state
            viewer.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Loading questions...</div>';
            
            // Function to process loaded HTML
            function processHTML(html) {
                // Extract body content from the HTML
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                var bodyContent = doc.body.innerHTML;
                
                // Inject content into viewer
                viewer.innerHTML = bodyContent;
                
                // Add copy buttons to all question cards
                addCopyButtons(viewer);
                
                // Re-initialize MathJax for the new content
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([viewer]).catch(function(err) {
                        console.log('MathJax error:', err);
                    });
                }
            }
            
            // Function to show error
            function showError(error) {
                console.error('Error loading file:', error);
                var errorMessage = isFileProtocol 
                    ? '<div style="text-align:center; padding:40px; color:#d32f2f; max-width:600px; margin:0 auto;">' +
                      '<p style="font-size:1.2em; font-weight:bold; margin-bottom:15px;">⚠️ Cannot Load Questions</p>' +
                      '<p style="font-size:0.95em; margin-bottom:15px; color:#333;">' +
                      'Mobile browsers block loading local files. Use a local web server instead.</p>' +
                      '<p style="font-size:0.9em; margin-top:20px; padding:15px; background:#e3f2fd; border-radius:8px; color:#1976d2;">' +
                      '<strong>✅ Solution: Use a Local Web Server</strong><br><br>' +
                      '1. Open terminal in the <code>temp</code> folder<br>' +
                      '2. Run: <code>python3 -m http.server 8000</code><br>' +
                      '3. On your phone, go to: <code>http://YOUR_IP:8000/main.html</code><br><br>' +
                      'Or double-click <code>start-server.sh</code> for easy setup!' +
                      '</p>' +
                      '<p style="font-size:0.85em; margin-top:15px; color:#666;">' +
                      'File attempted: ' + filename + '</p>' +
                      '</div>'
                    : '<div style="text-align:center; padding:40px; color:#d32f2f;">' +
                      '<p><strong>Error loading questions</strong></p>' +
                      '<p style="font-size:0.9em; margin-top:10px;">File: ' + filename + '</p>' +
                      '<p style="font-size:0.85em; margin-top:10px; color:#666;">' +
                      'Make sure all HTML files are in the same folder.</p>' +
                      '</div>';
                viewer.innerHTML = errorMessage;
            }
            
            // Try fetch first (works on most modern browsers)
            if (typeof fetch !== 'undefined') {
                fetch(filename)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('File not found: ' + filename);
                        }
                        return response.text();
                    })
                    .then(processHTML)
                    .catch(function(error) {
                        // Fallback to XMLHttpRequest if fetch fails
                        tryXHR();
                    });
            } else {
                // Fallback to XMLHttpRequest
                tryXHR();
            }
            
            // XMLHttpRequest fallback
            function tryXHR() {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', filename, true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 0 || xhr.status === 200) {
                            processHTML(xhr.responseText);
                        } else {
                            showError('HTTP ' + xhr.status);
                        }
                    }
                };
                xhr.onerror = function() {
                    showError('Network error');
                };
                try {
                    xhr.send();
                } catch (e) {
                    showError(e.message);
                }
            }
        }

        function loadContent() {
            if (useIframe) {
                loadContentIframe();
            } else {
                loadContentFetch();
            }
        }
        
        // Dynamically adjust iframe height for mobile
        function adjustIframeHeight() {
            if (!useIframe) return;
            
            var iframe = document.getElementById('year-viewer-iframe');
            var header = document.querySelector('.paper-container h1');
            var container = document.querySelector('.paper-container');
            
            // Calculate available height
            var windowHeight = window.innerHeight;
            var headerHeight = header ? header.offsetHeight : 60;
            var metaControlsHeight = document.querySelector('.meta-controls') ? document.querySelector('.meta-controls').offsetHeight : 50;
            var containerPadding = 20; // Top and bottom padding
            var margin = 20;
            
            // Calculate iframe height
            var availableHeight = windowHeight - headerHeight - metaControlsHeight - containerPadding - margin;
            
            // Set minimum height
            var minHeight = window.innerWidth <= 480 ? 400 : (window.innerWidth <= 768 ? 500 : 600);
            var iframeHeight = Math.max(availableHeight, minHeight);
            
            iframe.style.height = iframeHeight + 'px';
        }

        function setSection(sectionKey) {
            currentSection = sectionKey;
            updateControlsUI();
            loadContent();
        }

        function loadYear(year) {
            // Year buttons reuse the same naming scheme, based on current section
            currentYear = year;
            updateControlsUI();
            loadContent();
        }
        
        // Load initial content
        window.addEventListener('load', function () {
            updateControlsUI();
            loadContent();
            if (useIframe) {
                adjustIframeHeight();
            }
        });
        
        // Adjust iframe on resize (desktop only)
        if (useIframe) {
            window.addEventListener('resize', adjustIframeHeight);
            window.addEventListener('orientationchange', function() {
                setTimeout(adjustIframeHeight, 100);
            });
        }
        
        // Re-render MathJax on orientation change (mobile)
        if (!useIframe) {
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        var viewer = document.getElementById('year-viewer');
                        window.MathJax.typesetPromise([viewer]).catch(function(err) {
                            console.log('MathJax error:', err);
                        });
                    }
                }, 300);
            });
        }
    </script>

</body>
</html>