<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ISS Statistics Question Bank</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

    <div class="paper-container">
        <!-- Sticky Header -->
        <div class="sticky-header">
            <h1 id="paper-title">ISS Statistics Paper I</h1>
            <h2>Question Bank</h2>
            
            <div class="meta-controls">
                <div class="meta-line meta-section">
                    <span class="meta-value" id="section-value">Probability &amp; Statistics</span>
                    <select id="section-select" onchange="setSection(this.value)">
                        <option value="prob">Probability &amp; Statistics</option>
                        <option value="num">Numerical Analysis</option>
                        <option value="comp">Computer Section</option>
                    </select>
                </div>
                <div class="meta-line meta-paper">
                    <span class="meta-value" id="paper-value">Paper I</span>
                    <select id="paper-select" onchange="setPaper(this.value)">
                        <option value="paper1">Paper I</option>
                        <option value="paper2">Paper II</option>
                    </select>
                </div>
                <div class="meta-line meta-year">
                    <span class="meta-value" id="year-value">2025</span>
                    <select id="year-select" onchange="loadYear(this.value)">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                        <option value="2017">2017</option>
                    </select>
                </div>
            </div>
        </div>
    
        <!-- Content viewer -->
        <div id="year-viewer" class="content-viewer"></div>
    </div>
    
    <script src="answers.js"></script>
    <script>
        // Track current selection
        var currentPaper = 'paper1'; // 'paper1' | 'paper2'
        var currentYear = '2025';
        var currentSection = 'prob'; // Paper 1: 'prob' | 'num' | 'comp'; Paper 2: 'linear' | 'inference' | 'official'
        
        function buildFilename() {
            var prefix;
            var basePath;
            
            if (currentPaper === 'paper1') {
                basePath = 'extracted_htmls/stats_paper_1/';
                if (currentSection === 'prob') {
                    prefix = basePath + 'Probability_&_Statistics/Probability_and_Statistics_questions_';
                } else if (currentSection === 'num') {
                    prefix = basePath + 'Numerical_Analysis/Numerical_Analysis_questions_';
                } else if (currentSection === 'comp') {
                    prefix = basePath + 'Computer/Computer_questions_';
                } else {
                    // Fallback to Probability & Statistics
                    prefix = basePath + 'Probability_&_Statistics/Probability_and_Statistics_questions_';
                }
            } else if (currentPaper === 'paper2') {
                basePath = 'extracted_htmls/stats_paper_2/';
                if (currentSection === 'linear') {
                    prefix = basePath + 'Linear_Models/Linear_Models_questions_';
                } else if (currentSection === 'inference') {
                    prefix = basePath + 'Statistical_Inference_and_Hypothesis_Testing/Statistical_Inference_and_Hypothesis_Testing_questions_';
                } else if (currentSection === 'official') {
                    prefix = basePath + 'Official_Statistics/Official_Statistics_questions_';
                } else {
                    // Fallback to Linear Models
                    prefix = basePath + 'Linear_Models/Linear_Models_questions_';
                }
            }
            
            return prefix + currentYear + '.html';
        }

        // Copy button functionality - DRY principle
        function addCopyButtons(container) {
            var questionCards = container.querySelectorAll('.question-card');
            questionCards.forEach(function(card) {
                // Skip if button already exists
                if (card.querySelector('.q-copy-btn')) {
                    return;
                }
                
                // Create copy button
                var copyBtn = document.createElement('button');
                copyBtn.className = 'q-copy-btn';
                copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
                copyBtn.setAttribute('aria-label', 'Copy question');
                copyBtn.setAttribute('data-tooltip', 'Copy');
                
                // Add click handler
                copyBtn.addEventListener('click', function() {
                    copyQuestionText(card, copyBtn);
                });
                
                // Insert button into card
                card.style.position = 'relative';
                card.appendChild(copyBtn);
            });
        }

        function copyQuestionText(card, button) {
            try {
                // Extract question number
                var qNumberEl = card.querySelector('.q-number');
                var qNumber = qNumberEl ? qNumberEl.textContent.trim() : '';
                
                // Extract topic
                var qTopicEl = card.querySelector('.q-topic');
                var qTopic = qTopicEl ? qTopicEl.textContent.trim() : '';
                
                // Extract all question text (handle multiple q-text divs)
                var qTextEls = card.querySelectorAll('.q-text');
                var qText = '';
                qTextEls.forEach(function(el) {
                    var text = el.textContent.trim();
                    if (text) {
                        qText += text + '\n';
                    }
                });
                qText = qText.trim();
                
                // Extract context if exists
                var qContextEl = card.querySelector('.q-context');
                var qContext = '';
                if (qContextEl) {
                    qContext = qContextEl.textContent.trim() + '\n\n';
                }
                
                // Extract options
                var options = [];
                var optionItems = card.querySelectorAll('.option-item');
                optionItems.forEach(function(item) {
                    var optText = item.textContent.trim();
                    if (optText) {
                        options.push(optText);
                    }
                });
                
                // Build formatted text
                var formattedText = '';
                if (qContext) {
                    formattedText += qContext;
                }
                if (qNumber) {
                    formattedText += qNumber + ' ';
                }
                if (qTopic) {
                    formattedText += qTopic + '\n';
                }
                if (qText) {
                    formattedText += qText + '\n\n';
                }
                if (options.length > 0) {
                    formattedText += 'Options:\n';
                    options.forEach(function(opt) {
                        formattedText += opt + '\n';
                    });
                }
                
                // Copy to clipboard
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(formattedText).then(function() {
                        showCopySuccess(button);
                    }).catch(function(err) {
                        console.error('Failed to copy:', err);
                        fallbackCopy(formattedText, button);
                    });
                } else {
                    fallbackCopy(formattedText, button);
                }
            } catch (error) {
                console.error('Error copying question:', error);
            }
        }

        function showCopySuccess(button) {
            var originalHTML = button.innerHTML;
            button.classList.add('copied');
            // Same circular checkmark icon as show answer button, but green
            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#10b981" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>';
            button.setAttribute('data-tooltip', 'Copied!');
            setTimeout(function() {
                button.classList.remove('copied');
                button.innerHTML = originalHTML;
                button.setAttribute('data-tooltip', 'Copy');
            }, 2000);
        }

        function fallbackCopy(text, button) {
            // Fallback for older browsers
            var textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showCopySuccess(button);
            } catch (err) {
                console.error('Fallback copy failed:', err);
            }
            document.body.removeChild(textArea);
        }


        function updateControlsUI() {
            var paperValueEl = document.getElementById('paper-value');
            var paperTitleEl = document.getElementById('paper-title');
            var sectionValueEl = document.getElementById('section-value');
            var sectionSelectEl = document.getElementById('section-select');
            var yearValueEl = document.getElementById('year-value');

            // Update paper display
            if (paperValueEl) {
                paperValueEl.textContent = currentPaper === 'paper1' ? 'Paper I' : 'Paper II';
            }
            if (paperTitleEl) {
                paperTitleEl.textContent = currentPaper === 'paper1' ? 'ISS Statistics Paper I' : 'ISS Statistics Paper II';
            }

            // Update section dropdown based on paper
            if (sectionSelectEl) {
                sectionSelectEl.innerHTML = '';
                if (currentPaper === 'paper1') {
                    // Paper I sections
                    sectionSelectEl.innerHTML = 
                        '<option value="prob">Probability &amp; Statistics</option>' +
                        '<option value="num">Numerical Analysis</option>' +
                        '<option value="comp">Computer Section</option>';
                } else {
                    // Paper II sections
                    sectionSelectEl.innerHTML = 
                        '<option value="linear">Linear Models</option>' +
                        '<option value="inference">Statistical Inference and Hypothesis Testing</option>' +
                        '<option value="official">Official Statistics</option>';
                }
                // Set the selected option
                sectionSelectEl.value = currentSection;
            }

            // Update section display text
            if (sectionValueEl) {
                var sectionText = '';
                if (currentPaper === 'paper1') {
                    if (currentSection === 'prob') {
                        sectionText = 'Probability & Statistics';
                    } else if (currentSection === 'num') {
                        sectionText = 'Numerical Analysis';
                    } else if (currentSection === 'comp') {
                        sectionText = 'Computer Section';
                    }
                } else {
                    if (currentSection === 'linear') {
                        sectionText = 'Linear Models';
                    } else if (currentSection === 'inference') {
                        sectionText = 'Statistical Inference and Hypothesis Testing';
                    } else if (currentSection === 'official') {
                        sectionText = 'Official Statistics';
                    }
                }
                sectionValueEl.textContent = sectionText;
            }

            if (yearValueEl) {
                yearValueEl.textContent = currentYear;
            }
        }

        function setPaper(paperKey) {
            currentPaper = paperKey;
            // Reset section to first section of the selected paper
            if (currentPaper === 'paper1') {
                currentSection = 'prob';
            } else {
                currentSection = 'linear';
            }
            updateControlsUI();
            loadContent();
        }

        // Load content using fetch (works on both desktop and mobile)
        function loadContent() {
            var viewer = document.getElementById('year-viewer');
            var filename = buildFilename();
            
            // Show loading state
            viewer.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Loading questions...</div>';
            
            // Function to process loaded HTML
            function processHTML(html) {
                // Extract body content from the HTML
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                var bodyContent = doc.body.innerHTML;
                
                // Inject content into viewer
                viewer.innerHTML = bodyContent;
                
                // Initialize MathJax FIRST, then add buttons AFTER MathJax is done
                function initMathJaxInViewer() {
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        var mathJaxReady = Promise.resolve();
                        if (window.MathJax.startup && window.MathJax.startup.promise) {
                            mathJaxReady = window.MathJax.startup.promise;
                        }
                        
                        mathJaxReady.then(function() {
                            if (window.MathJax.typesetClear) {
                                try {
                                    window.MathJax.typesetClear([viewer]);
                                } catch (e) {
                                    var mathElements = viewer.querySelectorAll('.MathJax, [id^="MathJax"]');
                                    mathElements.forEach(function(el) {
                                        try { el.remove(); } catch (e2) {}
                                    });
                                }
                            } else {
                                var mathElements = viewer.querySelectorAll('.MathJax, [id^="MathJax"]');
                                mathElements.forEach(function(el) {
                                    try { el.remove(); } catch (e) {}
                                });
                            }
                            
                            return window.MathJax.typesetPromise([viewer]);
                        }).then(function() {
                            addCopyButtons(viewer);
                            addShowAnswerButtons(viewer);
                        }).catch(function(err) {
                            console.error('MathJax error:', err);
                            addCopyButtons(viewer);
                            addShowAnswerButtons(viewer);
                        });
                    } else {
                        setTimeout(initMathJaxInViewer, 100);
                    }
                }
                
                setTimeout(initMathJaxInViewer, 200);
            }
            
            // Function to show error
            function showError(error) {
                console.error('Error loading file:', error);
                var isFileProtocol = window.location.protocol === 'file:';
                var errorMessage = isFileProtocol 
                    ? '<div style="text-align:center; padding:40px; color:#d32f2f; max-width:600px; margin:0 auto;">' +
                      '<p style="font-size:1.2em; font-weight:bold; margin-bottom:15px;">⚠️ Cannot Load Questions</p>' +
                      '<p style="font-size:0.95em; margin-bottom:15px; color:#333;">' +
                      'To load local files, use a local web server instead of opening directly.</p>' +
                      '<p style="font-size:0.9em; margin-top:20px; padding:15px; background:#e3f2fd; border-radius:8px; color:#1976d2;">' +
                      '<strong>✅ Solution: Use a Local Web Server</strong><br><br>' +
                      '1. Open terminal in this folder<br>' +
                      '2. Run: <code>python3 -m http.server 8000</code><br>' +
                      '3. Go to: <code>http://localhost:8000/main.html</code><br><br>' +
                      'Or double-click <code>start-server.sh</code> for easy setup!' +
                      '</p>' +
                      '<p style="font-size:0.85em; margin-top:15px; color:#666;">' +
                      'File attempted: ' + filename + '</p>' +
                      '</div>'
                    : '<div style="text-align:center; padding:40px; color:#d32f2f;">' +
                      '<p><strong>Error loading questions</strong></p>' +
                      '<p style="font-size:0.9em; margin-top:10px;">File: ' + filename + '</p>' +
                      '<p style="font-size:0.85em; margin-top:10px; color:#666;">' +
                      'Make sure all HTML files are in the same folder.</p>' +
                      '</div>';
                viewer.innerHTML = errorMessage;
            }
            
            // Try fetch first, fallback to XHR
            if (typeof fetch !== 'undefined') {
                var cacheBuster = '?t=' + new Date().getTime();
                fetch(filename + cacheBuster, {
                    cache: 'no-store',
                    headers: { 'Cache-Control': 'no-cache, no-store, must-revalidate', 'Pragma': 'no-cache' }
                })
                    .then(function(response) {
                        if (!response.ok) throw new Error('File not found: ' + filename);
                        return response.text();
                    })
                    .then(processHTML)
                    .catch(function() { tryXHR(); });
            } else {
                tryXHR();
            }
            
            function tryXHR() {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', filename, true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 0 || xhr.status === 200) {
                            processHTML(xhr.responseText);
                        } else {
                            showError('HTTP ' + xhr.status);
                        }
                    }
                };
                xhr.onerror = function() { showError('Network error'); };
                try { xhr.send(); } catch (e) { showError(e.message); }
            }
        }

        function setSection(sectionKey) {
            currentSection = sectionKey;
            updateControlsUI();
            loadContent();
        }

        function loadYear(year) {
            // Year buttons reuse the same naming scheme, based on current section
            currentYear = year;
            updateControlsUI();
            loadContent();
        }
        
        // Load initial content
        window.addEventListener('load', function () {
            updateControlsUI();
            loadContent();
        });
        
        // Re-render MathJax on orientation change
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    var viewer = document.getElementById('year-viewer');
                    window.MathJax.typesetPromise([viewer]).catch(function(err) {
                        console.log('MathJax error:', err);
                    });
                }
            }, 300);
        });
    </script>

    <!-- Show Answer Functionality -->
    <script>
        // Map section keys to answer file keys
        var sectionToAnswerKey = {
            'prob': 'prob',
            'num': 'num',
            'comp': 'comp',
            'linear': 'linear',
            'inference': 'inference',
            'official': 'official'
        };

        // Add show answer buttons and functionality to a container
        function addShowAnswerButtons(container) {
            if (!container) return;
            
            // Get current answers for this paper/section/year
            var answers = QUESTION_ANSWERS[currentPaper];
            if (!answers) return;
            
            var sectionKey = sectionToAnswerKey[currentSection];
            var sectionAnswers = answers[sectionKey];
            if (!sectionAnswers) return;
            
            var yearAnswers = sectionAnswers[currentYear];
            if (!yearAnswers) return;
            
            // Get all question cards
            var questionCards = container.querySelectorAll('.question-card');
            
            questionCards.forEach(function(card) {
                // Skip if button already exists
                if (card.querySelector('.q-answer-btn')) {
                    return;
                }
                
                // Get question number
                var qNumberEl = card.querySelector('.q-number');
                if (!qNumberEl) return;
                
                var qNumber = qNumberEl.textContent.trim().replace('.', '');
                var correctAnswer = yearAnswers[qNumber];
                
                // Only add button if we have an answer for this question
                if (!correctAnswer) return;
                
                // Create show answer button (eye icon - shown by default)
                var answerBtn = document.createElement('button');
                answerBtn.className = 'q-answer-btn';
                answerBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
                answerBtn.setAttribute('aria-label', 'Show answer for question ' + qNumber);
                answerBtn.setAttribute('data-tooltip', 'Show Answer');
                
                // Add click handler
                answerBtn.addEventListener('click', function() {
                    toggleAnswer(card, answerBtn, correctAnswer);
                });
                
                // Ensure options-grid has position relative for absolute positioning
                var optionsGrid = card.querySelector('.options-grid');
                if (optionsGrid) {
                    optionsGrid.style.position = 'relative';
                    optionsGrid.appendChild(answerBtn);
                } else {
                    // Fallback to card if no options grid
                    card.style.position = 'relative';
                    card.appendChild(answerBtn);
                }
            });
        }

        // Toggle answer visibility
        function toggleAnswer(card, button, correctAnswer) {
            var isShowing = button.classList.contains('showing');
            var optLabel = correctAnswer.toLowerCase();
            var options = card.querySelectorAll('.option-item');
            
            if (!isShowing) {
                // Show answer - highlight the correct option
                options.forEach(function(opt) {
                    var label = opt.querySelector('.opt-label');
                    if (label && label.textContent.toLowerCase().includes('(' + optLabel + ')')) {
                        opt.classList.add('correct-answer');
                    }
                });
                button.classList.add('showing');
                button.classList.remove('hidden');
                // Change to "eye-off" icon when showing answer
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';
                button.setAttribute('data-tooltip', 'Hide Answer');
            } else {
                // Hide answer - remove highlight
                options.forEach(function(opt) {
                    opt.classList.remove('correct-answer');
                });
                button.classList.remove('showing');
                button.classList.add('hidden');
                // Change back to "eye" icon
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
                button.setAttribute('data-tooltip', 'Show Answer');
            }
        }
    </script>

</body>
</html>
