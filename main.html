<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ISS Statistics Question Bank</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

    <div class="paper-container">
        <h1 id="paper-title">ISS Statistics Paper I</h1>
        <h2>Question Bank</h2>
        
        <div class="meta-controls">
            <div class="meta-line meta-paper">
                <span class="meta-label">Paper</span>
                <span class="meta-value" id="paper-value">Paper I</span>
                <select id="paper-select" onchange="setPaper(this.value)">
                    <option value="paper1">Paper I</option>
                    <option value="paper2">Paper II</option>
                </select>
            </div>
            <div class="meta-line meta-section">
                <span class="meta-label">Section</span>
                <span class="meta-value" id="section-value">Probability &amp; Statistics</span>
                <select id="section-select" onchange="setSection(this.value)">
                    <option value="prob">Probability &amp; Statistics</option>
                    <option value="num">Numerical Analysis</option>
                    <option value="comp">Computer Section</option>
                </select>
            </div>
            <div class="meta-line meta-year">
                <span class="meta-label">Year</span>
                <span class="meta-value" id="year-value">2025</span>
                <select id="year-select" onchange="loadYear(this.value)">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                    <option value="2017">2017</option>
                </select>
            </div>
        </div>
    
        <!-- Use iframe for desktop, div for mobile -->
        <iframe id="year-viewer-iframe" width="100%" frameborder="0" style="border: none; display: none;"></iframe>
        <div id="year-viewer" class="content-viewer" style="display: none;"></div>
    </div>
    
    <script src="answers.js"></script>
    <script>
        // Track current selection
        var currentPaper = 'paper1'; // 'paper1' | 'paper2'
        var currentYear = '2025';
        var currentSection = 'prob'; // Paper 1: 'prob' | 'num' | 'comp'; Paper 2: 'linear' | 'inference' | 'official'
        
        // Detect if we should use iframe (desktop) or fetch (mobile)
        var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        var isFileProtocol = window.location.protocol === 'file:';
        var useIframe = !isMobile && isFileProtocol; // Use iframe on desktop with file://, fetch on mobile or http://

        function buildFilename() {
            var prefix;
            var basePath;
            
            if (currentPaper === 'paper1') {
                basePath = 'extracted_htmls/stats_paper_1/';
                if (currentSection === 'prob') {
                    prefix = basePath + 'Probability_&_Statistics/Probability_and_Statistics_questions_';
                } else if (currentSection === 'num') {
                    prefix = basePath + 'Numerical_Analysis/Numerical_Analysis_questions_';
                } else if (currentSection === 'comp') {
                    prefix = basePath + 'Computer/Computer_questions_';
                } else {
                    // Fallback to Probability & Statistics
                    prefix = basePath + 'Probability_&_Statistics/Probability_and_Statistics_questions_';
                }
            } else if (currentPaper === 'paper2') {
                basePath = 'extracted_htmls/stats_paper_2/';
                if (currentSection === 'linear') {
                    prefix = basePath + 'Linear_Models/Linear_Models_questions_';
                } else if (currentSection === 'inference') {
                    prefix = basePath + 'Statistical_Inference_and_Hypothesis_Testing/Statistical_Inference_and_Hypothesis_Testing_questions_';
                } else if (currentSection === 'official') {
                    prefix = basePath + 'Official_Statistics/Official_Statistics_questions_';
                } else {
                    // Fallback to Linear Models
                    prefix = basePath + 'Linear_Models/Linear_Models_questions_';
                }
            }
            
            return prefix + currentYear + '.html';
        }

        // Copy button functionality - DRY principle
        function addCopyButtons(container) {
            var questionCards = container.querySelectorAll('.question-card');
            questionCards.forEach(function(card) {
                // Skip if button already exists
                if (card.querySelector('.q-copy-btn')) {
                    return;
                }
                
                // Create copy button
                var copyBtn = document.createElement('button');
                copyBtn.className = 'q-copy-btn';
                copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
                copyBtn.setAttribute('aria-label', 'Copy question');
                copyBtn.setAttribute('data-tooltip', 'Copy');
                
                // Add click handler
                copyBtn.addEventListener('click', function() {
                    copyQuestionText(card, copyBtn);
                });
                
                // Insert button into card
                card.style.position = 'relative';
                card.appendChild(copyBtn);
            });
        }

        function copyQuestionText(card, button) {
            try {
                // Extract question number
                var qNumberEl = card.querySelector('.q-number');
                var qNumber = qNumberEl ? qNumberEl.textContent.trim() : '';
                
                // Extract topic
                var qTopicEl = card.querySelector('.q-topic');
                var qTopic = qTopicEl ? qTopicEl.textContent.trim() : '';
                
                // Extract all question text (handle multiple q-text divs)
                var qTextEls = card.querySelectorAll('.q-text');
                var qText = '';
                qTextEls.forEach(function(el) {
                    var text = el.textContent.trim();
                    if (text) {
                        qText += text + '\n';
                    }
                });
                qText = qText.trim();
                
                // Extract context if exists
                var qContextEl = card.querySelector('.q-context');
                var qContext = '';
                if (qContextEl) {
                    qContext = qContextEl.textContent.trim() + '\n\n';
                }
                
                // Extract options
                var options = [];
                var optionItems = card.querySelectorAll('.option-item');
                optionItems.forEach(function(item) {
                    var optText = item.textContent.trim();
                    if (optText) {
                        options.push(optText);
                    }
                });
                
                // Build formatted text
                var formattedText = '';
                if (qContext) {
                    formattedText += qContext;
                }
                if (qNumber) {
                    formattedText += qNumber + ' ';
                }
                if (qTopic) {
                    formattedText += qTopic + '\n';
                }
                if (qText) {
                    formattedText += qText + '\n\n';
                }
                if (options.length > 0) {
                    formattedText += 'Options:\n';
                    options.forEach(function(opt) {
                        formattedText += opt + '\n';
                    });
                }
                
                // Copy to clipboard
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(formattedText).then(function() {
                        showCopySuccess(button);
                    }).catch(function(err) {
                        console.error('Failed to copy:', err);
                        fallbackCopy(formattedText, button);
                    });
                } else {
                    fallbackCopy(formattedText, button);
                }
            } catch (error) {
                console.error('Error copying question:', error);
            }
        }

        function showCopySuccess(button) {
            var originalHTML = button.innerHTML;
            button.classList.add('copied');
            // Same circular checkmark icon as show answer button, but green
            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#10b981" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>';
            button.setAttribute('data-tooltip', 'Copied!');
            setTimeout(function() {
                button.classList.remove('copied');
                button.innerHTML = originalHTML;
                button.setAttribute('data-tooltip', 'Copy');
            }, 2000);
        }

        function fallbackCopy(text, button) {
            // Fallback for older browsers
            var textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showCopySuccess(button);
            } catch (err) {
                console.error('Fallback copy failed:', err);
            }
            document.body.removeChild(textArea);
        }


        function updateControlsUI() {
            var paperValueEl = document.getElementById('paper-value');
            var paperTitleEl = document.getElementById('paper-title');
            var sectionValueEl = document.getElementById('section-value');
            var sectionSelectEl = document.getElementById('section-select');
            var yearValueEl = document.getElementById('year-value');

            // Update paper display
            if (paperValueEl) {
                paperValueEl.textContent = currentPaper === 'paper1' ? 'Paper I' : 'Paper II';
            }
            if (paperTitleEl) {
                paperTitleEl.textContent = currentPaper === 'paper1' ? 'ISS Statistics Paper I' : 'ISS Statistics Paper II';
            }

            // Update section dropdown based on paper
            if (sectionSelectEl) {
                sectionSelectEl.innerHTML = '';
                if (currentPaper === 'paper1') {
                    // Paper I sections
                    sectionSelectEl.innerHTML = 
                        '<option value="prob">Probability &amp; Statistics</option>' +
                        '<option value="num">Numerical Analysis</option>' +
                        '<option value="comp">Computer Section</option>';
                } else {
                    // Paper II sections
                    sectionSelectEl.innerHTML = 
                        '<option value="linear">Linear Models</option>' +
                        '<option value="inference">Statistical Inference and Hypothesis Testing</option>' +
                        '<option value="official">Official Statistics</option>';
                }
                // Set the selected option
                sectionSelectEl.value = currentSection;
            }

            // Update section display text
            if (sectionValueEl) {
                var sectionText = '';
                if (currentPaper === 'paper1') {
                    if (currentSection === 'prob') {
                        sectionText = 'Probability & Statistics';
                    } else if (currentSection === 'num') {
                        sectionText = 'Numerical Analysis';
                    } else if (currentSection === 'comp') {
                        sectionText = 'Computer Section';
                    }
                } else {
                    if (currentSection === 'linear') {
                        sectionText = 'Linear Models';
                    } else if (currentSection === 'inference') {
                        sectionText = 'Statistical Inference and Hypothesis Testing';
                    } else if (currentSection === 'official') {
                        sectionText = 'Official Statistics';
                    }
                }
                sectionValueEl.textContent = sectionText;
            }

            if (yearValueEl) {
                yearValueEl.textContent = currentYear;
            }
        }

        function setPaper(paperKey) {
            currentPaper = paperKey;
            // Reset section to first section of the selected paper
            if (currentPaper === 'paper1') {
                currentSection = 'prob';
            } else {
                currentSection = 'linear';
            }
            updateControlsUI();
            loadContent();
        }

        // Load content using iframe (for desktop file://)
        function loadContentIframe() {
            var iframe = document.getElementById('year-viewer-iframe');
            var div = document.getElementById('year-viewer');
            var filename = buildFilename();
            
            iframe.style.display = 'block';
            div.style.display = 'none';
            
            // Load content via fetch and inject into iframe to avoid CORS issues
            fetch(filename)
                .then(function(response) {
                    if (!response.ok) throw new Error('File not found');
                    return response.text();
                })
                .then(function(html) {
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(html, 'text/html');
                    var bodyContent = doc.body.innerHTML;
                    
                    // Inject copy button script into body content  
                    // Note: Copy buttons will be added via iframe onload handler instead
                    // to avoid script injection issues
                    
                    // Write to iframe
                    var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    var iframeWindow = iframe.contentWindow;
                    iframeDoc.open();
                    // Use absolute path for stylesheet (from main.html's location)
                    var basePath = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                    // Inject copy button CSS directly to ensure it loads
                    var copyButtonCSS = '<style>.q-copy-btn{position:absolute;top:12px;right:12px;background:#6366f1;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;font-size:0.875rem;font-weight:600;display:flex;align-items:center;gap:6px;transition:background-color 0.2s ease,transform 0.1s ease;box-shadow:0 2px 4px rgba(99,102,241,0.2);z-index:10;}.q-copy-btn:hover{background:#4f46e5;transform:translateY(-1px);box-shadow:0 4px 8px rgba(99,102,241,0.3);}.q-copy-btn:active{transform:translateY(0);background:#4338ca;}.q-copy-btn.copied{background:#10b981;}.q-copy-btn.copied:hover{background:#059669;}.q-copy-btn svg{width:16px;height:16px;fill:currentColor;}@media (max-width:768px){.q-copy-btn{top:8px;right:8px;padding:6px 10px;font-size:0.8rem;}.q-copy-btn svg{width:14px;height:14px;}}.question-card{position:relative;}</style>';
                    // Include MathJax scripts in iframe (using proper escaping)
                    var mathJaxScripts = '<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"><\/script><script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>';
                    iframeDoc.write('<!DOCTYPE html><html><head><base href="' + basePath + '"><link rel="stylesheet" href="styles.css">' + copyButtonCSS + mathJaxScripts + '</head><body>' + bodyContent + '</body></html>');
                    iframeDoc.close();
                    
                    // Add copy buttons after iframe content loads
                    setTimeout(function() {
                        try {
                            addCopyButtons(iframeDoc.body);
                            console.log('Copy buttons added to iframe');
                        } catch (e) {
                            console.log('Could not add copy buttons to iframe:', e);
                        }
                    }, 200);
                    
                    // Initialize MathJax in iframe (wait for it to load)
                    function initMathJaxInIframe() {
                        if (iframeWindow.MathJax && iframeWindow.MathJax.typesetPromise) {
                            iframeWindow.MathJax.typesetPromise([iframeDoc.body]).catch(function(err) {
                                console.log('MathJax error in iframe:', err);
                            });
                        } else {
                            // Wait a bit more for MathJax to load
                            setTimeout(initMathJaxInIframe, 100);
                        }
                    }
                    
                    // Start MathJax initialization after a short delay
                    setTimeout(initMathJaxInIframe, 300);
                })
                .catch(function(error) {
                    console.error('Error loading file:', error);
                    // Fallback to direct iframe load
                    iframe.src = filename;
                    iframe.onload = function() {
                        try {
                            var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            setTimeout(function() {
                                addCopyButtons(iframeDoc.body);
                            }, 100);
                        } catch (e) {
                            console.log('Cannot access iframe content:', e);
                        }
                    };
                });
            
            // Adjust iframe height
            adjustIframeHeight();
        }

        // Load content using fetch/XHR (for mobile or http://)
        function loadContentFetch() {
            var iframe = document.getElementById('year-viewer-iframe');
            var viewer = document.getElementById('year-viewer');
            var filename = buildFilename();
            
            iframe.style.display = 'none';
            viewer.style.display = 'block';
            
            // Show loading state
            viewer.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Loading questions...</div>';
            
            // Function to process loaded HTML
            function processHTML(html) {
                // Extract body content from the HTML
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                var bodyContent = doc.body.innerHTML;
                
                // Inject content into viewer
                viewer.innerHTML = bodyContent;
                
                // Initialize MathJax FIRST, then add copy buttons AFTER MathJax is done
                // This prevents DOM manipulation from interfering with MathJax processing
                function initMathJaxInViewer() {
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        // Wait for MathJax to be fully ready using startup promise
                        var mathJaxReady = Promise.resolve();
                        if (window.MathJax.startup && window.MathJax.startup.promise) {
                            mathJaxReady = window.MathJax.startup.promise;
                        }
                        
                        mathJaxReady.then(function() {
                            // Clear previous MathJax output - use typesetClear if available
                            if (window.MathJax.typesetClear) {
                                try {
                                    window.MathJax.typesetClear([viewer]);
                                } catch (e) {
                                    // If typesetClear fails, manually remove MathJax output
                                    var mathElements = viewer.querySelectorAll('.MathJax, [id^="MathJax"]');
                                    mathElements.forEach(function(el) {
                                        try {
                                            el.remove();
                                        } catch (e2) {
                                            // Ignore removal errors
                                        }
                                    });
                                }
                            } else {
                                // Fallback: manually remove MathJax output
                                var mathElements = viewer.querySelectorAll('.MathJax, [id^="MathJax"]');
                                mathElements.forEach(function(el) {
                                    try {
                                        el.remove();
                                    } catch (e) {
                                        // Ignore removal errors
                                    }
                                });
                            }
                            
                            // Typeset the new content - MathJax will process all math expressions
                            // Process the entire viewer element to ensure all q-text, q-context, and option-item elements are handled
                            return window.MathJax.typesetPromise([viewer]);
                        }).then(function() {
                            // Add copy buttons AFTER MathJax has finished processing
                            // This ensures DOM manipulation doesn't interfere with math rendering
                            addCopyButtons(viewer);
                        }).catch(function(err) {
                            console.error('MathJax error:', err);
                            // Even if MathJax fails, add copy buttons
                            addCopyButtons(viewer);
                        });
                    } else {
                        // Wait a bit more for MathJax to load
                        setTimeout(initMathJaxInViewer, 100);
                    }
                }
                
                // Start MathJax initialization after DOM is ready
                // Use a delay to ensure content is fully injected and DOM is stable
                setTimeout(initMathJaxInViewer, 200);
            }
            
            // Function to show error
            function showError(error) {
                console.error('Error loading file:', error);
                var errorMessage = isFileProtocol 
                    ? '<div style="text-align:center; padding:40px; color:#d32f2f; max-width:600px; margin:0 auto;">' +
                      '<p style="font-size:1.2em; font-weight:bold; margin-bottom:15px;">⚠️ Cannot Load Questions</p>' +
                      '<p style="font-size:0.95em; margin-bottom:15px; color:#333;">' +
                      'Mobile browsers block loading local files. Use a local web server instead.</p>' +
                      '<p style="font-size:0.9em; margin-top:20px; padding:15px; background:#e3f2fd; border-radius:8px; color:#1976d2;">' +
                      '<strong>✅ Solution: Use a Local Web Server</strong><br><br>' +
                      '1. Open terminal in the <code>temp</code> folder<br>' +
                      '2. Run: <code>python3 -m http.server 8000</code><br>' +
                      '3. On your phone, go to: <code>http://YOUR_IP:8000/main.html</code><br><br>' +
                      'Or double-click <code>start-server.sh</code> for easy setup!' +
                      '</p>' +
                      '<p style="font-size:0.85em; margin-top:15px; color:#666;">' +
                      'File attempted: ' + filename + '</p>' +
                      '</div>'
                    : '<div style="text-align:center; padding:40px; color:#d32f2f;">' +
                      '<p><strong>Error loading questions</strong></p>' +
                      '<p style="font-size:0.9em; margin-top:10px;">File: ' + filename + '</p>' +
                      '<p style="font-size:0.85em; margin-top:10px; color:#666;">' +
                      'Make sure all HTML files are in the same folder.</p>' +
                      '</div>';
                viewer.innerHTML = errorMessage;
            }
            
            // Try fetch first (works on most modern browsers)
            // Add cache-busting parameter to prevent browser caching
            if (typeof fetch !== 'undefined') {
                var cacheBuster = '?t=' + new Date().getTime();
                fetch(filename + cacheBuster, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                })
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('File not found: ' + filename);
                        }
                        return response.text();
                    })
                    .then(processHTML)
                    .catch(function(error) {
                        // Fallback to XMLHttpRequest if fetch fails
                        tryXHR();
                    });
            } else {
                // Fallback to XMLHttpRequest
                tryXHR();
            }
            
            // XMLHttpRequest fallback
            function tryXHR() {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', filename, true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 0 || xhr.status === 200) {
                            processHTML(xhr.responseText);
                        } else {
                            showError('HTTP ' + xhr.status);
                        }
                    }
                };
                xhr.onerror = function() {
                    showError('Network error');
                };
                try {
                    xhr.send();
                } catch (e) {
                    showError(e.message);
                }
            }
        }

        function loadContent() {
            if (useIframe) {
                loadContentIframe();
            } else {
                loadContentFetch();
            }
        }
        
        // Dynamically adjust iframe height for mobile
        function adjustIframeHeight() {
            if (!useIframe) return;
            
            var iframe = document.getElementById('year-viewer-iframe');
            var header = document.querySelector('.paper-container h1');
            var container = document.querySelector('.paper-container');
            
            // Calculate available height
            var windowHeight = window.innerHeight;
            var headerHeight = header ? header.offsetHeight : 60;
            var metaControlsHeight = document.querySelector('.meta-controls') ? document.querySelector('.meta-controls').offsetHeight : 50;
            var containerPadding = 20; // Top and bottom padding
            var margin = 20;
            
            // Calculate iframe height
            var availableHeight = windowHeight - headerHeight - metaControlsHeight - containerPadding - margin;
            
            // Set minimum height
            var minHeight = window.innerWidth <= 480 ? 400 : (window.innerWidth <= 768 ? 500 : 600);
            var iframeHeight = Math.max(availableHeight, minHeight);
            
            iframe.style.height = iframeHeight + 'px';
        }

        function setSection(sectionKey) {
            currentSection = sectionKey;
            updateControlsUI();
            loadContent();
        }

        function loadYear(year) {
            // Year buttons reuse the same naming scheme, based on current section
            currentYear = year;
            updateControlsUI();
            loadContent();
        }
        
        // Load initial content
        window.addEventListener('load', function () {
            updateControlsUI();
            loadContent();
            if (useIframe) {
                adjustIframeHeight();
            }
        });
        
        // Adjust iframe on resize (desktop only)
        if (useIframe) {
            window.addEventListener('resize', adjustIframeHeight);
            window.addEventListener('orientationchange', function() {
                setTimeout(adjustIframeHeight, 100);
            });
        }
        
        // Re-render MathJax on orientation change (mobile)
        if (!useIframe) {
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        var viewer = document.getElementById('year-viewer');
                        window.MathJax.typesetPromise([viewer]).catch(function(err) {
                            console.log('MathJax error:', err);
                        });
                    }
                }, 300);
            });
        }
    </script>

    <!-- Show Answer Functionality -->
    <script>
        // Map section keys to answer file keys
        var sectionToAnswerKey = {
            'prob': 'prob',
            'num': 'num',
            'comp': 'comp',
            'linear': 'linear',
            'inference': 'inference',
            'official': 'official'
        };

        // Add show answer buttons and functionality to a container
        function addShowAnswerButtons(container) {
            if (!container) return;
            
            // Get current answers for this paper/section/year
            var answers = QUESTION_ANSWERS[currentPaper];
            if (!answers) return;
            
            var sectionKey = sectionToAnswerKey[currentSection];
            var sectionAnswers = answers[sectionKey];
            if (!sectionAnswers) return;
            
            var yearAnswers = sectionAnswers[currentYear];
            if (!yearAnswers) return;
            
            // Get all question cards
            var questionCards = container.querySelectorAll('.question-card');
            
            questionCards.forEach(function(card) {
                // Skip if button already exists
                if (card.querySelector('.q-answer-btn')) {
                    return;
                }
                
                // Get question number
                var qNumberEl = card.querySelector('.q-number');
                if (!qNumberEl) return;
                
                var qNumber = qNumberEl.textContent.trim().replace('.', '');
                var correctAnswer = yearAnswers[qNumber];
                
                // Only add button if we have an answer for this question
                if (!correctAnswer) return;
                
                // Create show answer button (eye icon - shown by default)
                var answerBtn = document.createElement('button');
                answerBtn.className = 'q-answer-btn';
                answerBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
                answerBtn.setAttribute('aria-label', 'Show answer for question ' + qNumber);
                answerBtn.setAttribute('data-tooltip', 'Show Answer');
                
                // Add click handler
                answerBtn.addEventListener('click', function() {
                    toggleAnswer(card, answerBtn, correctAnswer);
                });
                
                // Ensure options-grid has position relative for absolute positioning
                var optionsGrid = card.querySelector('.options-grid');
                if (optionsGrid) {
                    optionsGrid.style.position = 'relative';
                    optionsGrid.appendChild(answerBtn);
                } else {
                    // Fallback to card if no options grid
                    card.style.position = 'relative';
                    card.appendChild(answerBtn);
                }
            });
        }

        // Toggle answer visibility
        function toggleAnswer(card, button, correctAnswer) {
            var isShowing = button.classList.contains('showing');
            var optLabel = correctAnswer.toLowerCase();
            var options = card.querySelectorAll('.option-item');
            
            if (!isShowing) {
                // Show answer - highlight the correct option
                options.forEach(function(opt) {
                    var label = opt.querySelector('.opt-label');
                    if (label && label.textContent.toLowerCase().includes('(' + optLabel + ')')) {
                        opt.classList.add('correct-answer');
                    }
                });
                button.classList.add('showing');
                button.classList.remove('hidden');
                // Change to "eye-off" icon when showing answer
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';
                button.setAttribute('data-tooltip', 'Hide Answer');
            } else {
                // Hide answer - remove highlight
                options.forEach(function(opt) {
                    opt.classList.remove('correct-answer');
                });
                button.classList.remove('showing');
                button.classList.add('hidden');
                // Change back to "eye" icon
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
                button.setAttribute('data-tooltip', 'Show Answer');
            }
        }

        // Override loadContentIframe to add answer buttons after iframe loads
        var originalLoadContentIframe = loadContentIframe;
        loadContentIframe = function() {
            var iframe = document.getElementById('year-viewer-iframe');
            var div = document.getElementById('year-viewer');
            var filename = buildFilename();
            
            iframe.style.display = 'block';
            div.style.display = 'none';
            
            fetch(filename)
                .then(function(response) {
                    if (!response.ok) throw new Error('File not found');
                    return response.text();
                })
                .then(function(html) {
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(html, 'text/html');
                    var bodyContent = doc.body.innerHTML;
                    
                    var iframe = document.getElementById('year-viewer-iframe');
                    var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    var iframeWindow = iframe.contentWindow;
                    iframeDoc.open();
                    var basePath = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                    var copyButtonCSS = '<style>.q-copy-btn{position:absolute;top:12px;right:12px;background:#6366f1;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;font-size:0.875rem;font-weight:600;display:flex;align-items:center;gap:6px;transition:background-color 0.2s ease,transform 0.1s ease;box-shadow:0 2px 4px rgba(99,102,241,0.2);z-index:10;}.q-copy-btn:hover{background:#4f46e5;transform:translateY(-1px);box-shadow:0 4px 8px rgba(99,102,241,0.3);}.q-copy-btn:active{transform:translateY(0);background:#4338ca;}.q-copy-btn.copied{background:#10b981;}.q-copy-btn.copied:hover{background:#059669;}.q-copy-btn svg{width:16px;height:16px;fill:currentColor;}@media (max-width:768px){.q-copy-btn{top:8px;right:8px;padding:6px 10px;font-size:0.8rem;}.q-copy-btn svg{width:14px;height:14px;}}.question-card{position:relative;}</style>';
                    var mathJaxScripts = '<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"><\/script><script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>';
                    
                    // Inject answers.js into iframe
                    var answersScript = '<script src="answers.js"><\/script>';
                    
                    iframeDoc.write('<!DOCTYPE html><html><head><base href="' + basePath + '"><link rel="stylesheet" href="styles.css">' + copyButtonCSS + mathJaxScripts + answersScript + '</head><body>' + bodyContent + '</body></html>');
                    iframeDoc.close();
                    
                    // Add copy buttons and answer buttons after iframe content loads
                    setTimeout(function() {
                        try {
                            addCopyButtons(iframeDoc.body);
                            // Add show answer buttons in iframe
                            addShowAnswerButtonsInIframe(iframeWindow, iframeDoc.body);
                            console.log('Copy buttons and answer buttons added to iframe');
                        } catch (e) {
                            console.log('Could not add buttons to iframe:', e);
                        }
                    }, 200);
                    
                    function initMathJaxInIframe() {
                        if (iframeWindow.MathJax && iframeWindow.MathJax.typesetPromise) {
                            iframeWindow.MathJax.typesetPromise([iframeDoc.body]).catch(function(err) {
                                console.log('MathJax error in iframe:', err);
                            });
                        } else {
                            setTimeout(initMathJaxInIframe, 100);
                        }
                    }
                    
                    setTimeout(initMathJaxInIframe, 300);
                })
                .catch(function(error) {
                    console.error('Error loading file:', error);
                    var iframe = document.getElementById('year-viewer-iframe');
                    iframe.src = filename;
                    iframe.onload = function() {
                        try {
                            var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            setTimeout(function() {
                                addCopyButtons(iframeDoc.body);
                                addShowAnswerButtonsInIframe(iframe.contentWindow, iframeDoc.body);
                            }, 100);
                        } catch (e) {
                            console.log('Cannot access iframe content:', e);
                        }
                    };
                });
            
            adjustIframeHeight();
        };

        // Add answer buttons in iframe context
        function addShowAnswerButtonsInIframe(iframeWindow, iframeBody) {
            if (!iframeWindow.QUESTION_ANSWERS) return;
            
            var answers = iframeWindow.QUESTION_ANSWERS[currentPaper];
            if (!answers) return;
            
            var sectionKey = sectionToAnswerKey[currentSection];
            var sectionAnswers = answers[sectionKey];
            if (!sectionAnswers) return;
            
            var yearAnswers = sectionAnswers[currentYear];
            if (!yearAnswers) return;
            
            var questionCards = iframeBody.querySelectorAll('.question-card');
            
            questionCards.forEach(function(card) {
                if (card.querySelector('.q-answer-btn')) return;
                
                var qNumberEl = card.querySelector('.q-number');
                if (!qNumberEl) return;
                
                var qNumber = qNumberEl.textContent.trim().replace('.', '');
                var correctAnswer = yearAnswers[qNumber];
                
                if (!correctAnswer) return;
                
                var answerBtn = document.createElement('button');
                answerBtn.className = 'q-answer-btn';
                answerBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
                answerBtn.setAttribute('aria-label', 'Show answer for question ' + qNumber);
                answerBtn.setAttribute('data-tooltip', 'Show Answer');
                
                answerBtn.addEventListener('click', function() {
                    toggleAnswerInIframe(card, answerBtn, correctAnswer, iframeWindow);
                });
                
                // Append to options-grid instead of card
                var optionsGrid = card.querySelector('.options-grid');
                if (optionsGrid) {
                    optionsGrid.style.position = 'relative';
                    optionsGrid.appendChild(answerBtn);
                } else {
                    card.style.position = 'relative';
                    card.appendChild(answerBtn);
                }
            });
        }

        // Toggle answer in iframe
        function toggleAnswerInIframe(card, button, correctAnswer, iframeWindow) {
            var isShowing = button.classList.contains('showing');
            var optLabel = correctAnswer.toLowerCase();
            var options = card.querySelectorAll('.option-item');
            
            if (!isShowing) {
                options.forEach(function(opt) {
                    var label = opt.querySelector('.opt-label');
                    if (label && label.textContent.toLowerCase().includes('(' + optLabel + ')')) {
                        opt.classList.add('correct-answer');
                    }
                });
                button.classList.add('showing');
                button.classList.remove('hidden');
                // Eye-off icon when showing answer
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';
                button.setAttribute('data-tooltip', 'Hide Answer');
            } else {
                options.forEach(function(opt) {
                    opt.classList.remove('correct-answer');
                });
                button.classList.remove('showing');
                button.classList.add('hidden');
                // Eye icon when hiding answer
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
                button.setAttribute('data-tooltip', 'Show Answer');
            }
        }

        // Override processHTML in loadContentFetch to add answer buttons
        var originalLoadContentFetch = loadContentFetch;
        loadContentFetch = function() {
            var iframe = document.getElementById('year-viewer-iframe');
            var viewer = document.getElementById('year-viewer');
            var filename = buildFilename();
            
            iframe.style.display = 'none';
            viewer.style.display = 'block';
            
            viewer.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Loading questions...</div>';
            
            function processHTML(html) {
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                var bodyContent = doc.body.innerHTML;
                
                viewer.innerHTML = bodyContent;
                
                function initMathJaxInViewer() {
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        var mathJaxReady = Promise.resolve();
                        if (window.MathJax.startup && window.MathJax.startup.promise) {
                            mathJaxReady = window.MathJax.startup.promise;
                        }
                        
                        mathJaxReady.then(function() {
                            if (window.MathJax.typesetClear) {
                                try {
                                    window.MathJax.typesetClear([viewer]);
                                } catch (e) {
                                    var mathElements = viewer.querySelectorAll('.MathJax, [id^="MathJax"]');
                                    mathElements.forEach(function(el) {
                                        try {
                                            el.remove();
                                        } catch (e2) {}
                                    });
                                }
                            } else {
                                var mathElements = viewer.querySelectorAll('.MathJax, [id^="MathJax"]');
                                mathElements.forEach(function(el) {
                                    try {
                                        el.remove();
                                    } catch (e) {}
                                });
                            }
                            
                            return window.MathJax.typesetPromise([viewer]);
                        }).then(function() {
                            // Add copy buttons AND show answer buttons AFTER MathJax
                            addCopyButtons(viewer);
                            addShowAnswerButtons(viewer);
                        }).catch(function(err) {
                            console.error('MathJax error:', err);
                            addCopyButtons(viewer);
                            addShowAnswerButtons(viewer);
                        });
                    } else {
                        setTimeout(initMathJaxInViewer, 100);
                    }
                }
                
                setTimeout(initMathJaxInViewer, 200);
            }
            
            function showError(error) {
                console.error('Error loading file:', error);
                var errorMessage = isFileProtocol 
                    ? '<div style="text-align:center; padding:40px; color:#d32f2f; max-width:600px; margin:0 auto;">' +
                      '<p style="font-size:1.2em; font-weight:bold; margin-bottom:15px;">⚠️ Cannot Load Questions</p>' +
                      '<p style="font-size:0.95em; margin-bottom:15px; color:#333;">' +
                      'Mobile browsers block loading local files. Use a local web server instead.</p>' +
                      '<p style="font-size:0.9em; margin-top:20px; padding:15px; background:#e3f2fd; border-radius:8px; color:#1976d2;">' +
                      '<strong>✅ Solution: Use a Local Web Server</strong><br><br>' +
                      '1. Open terminal in the <code>temp</code> folder<br>' +
                      '2. Run: <code>python3 -m http.server 8000</code><br>' +
                      '3. On your phone, go to: <code>http://YOUR_IP:8000/main.html</code><br><br>' +
                      'Or double-click <code>start-server.sh</code> for easy setup!' +
                      '</p>' +
                      '<p style="font-size:0.85em; margin-top:15px; color:#666;">' +
                      'File attempted: ' + filename + '</p>' +
                      '</div>'
                    : '<div style="text-align:center; padding:40px; color:#d32f2f;">' +
                      '<p><strong>Error loading questions</strong></p>' +
                      '<p style="font-size:0.9em; margin-top:10px;">File: ' + filename + '</p>' +
                      '<p style="font-size:0.85em; margin-top:10px; color:#666;">' +
                      'Make sure all HTML files are in the same folder.</p>' +
                      '</div>';
                viewer.innerHTML = errorMessage;
            }
            
            if (typeof fetch !== 'undefined') {
                var cacheBuster = '?t=' + new Date().getTime();
                fetch(filename + cacheBuster, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                })
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('File not found: ' + filename);
                        }
                        return response.text();
                    })
                    .then(processHTML)
                    .catch(function(error) {
                        tryXHR();
                    });
            } else {
                tryXHR();
            }
            
            function tryXHR() {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', filename, true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 0 || xhr.status === 200) {
                            processHTML(xhr.responseText);
                        } else {
                            showError('HTTP ' + xhr.status);
                        }
                    }
                };
                xhr.onerror = function() {
                    showError('Network error');
                };
                try {
                    xhr.send();
                } catch (e) {
                    showError(e.message);
                }
            }
        };
    </script>

</body>
</html>